name: build and deploy test server
on: workflow_dispatch
jobs:
    build:
        name: Build & Publish
        runs-on: ubuntu-latest
        steps:
          - name: Echo current dir
            run: echo ${{ github.GITHUB_WORKSPACE }}
            
          - name: Checkout repository
            uses: actions/checkout@v3
            
          - name: Set up QEMU
            uses: docker/setup-qemu-action@v2
            
          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v2

          - name: Login to Docker Hub
            uses: docker/login-action@v2
            with:
                username: ${{ secrets.DOCKERHUB_USER }}
                password: ${{ secrets.DOCKERHUB_TOKEN }}

          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v2
            
          - name: Build & Deploy template-server
            uses: docker/build-push-action@v4
            with:
                context: ./backend
                push: true
                file: ./backend/Dockerfile
                tags: ${{ secrets.DOCKERHUB_USER }}/test:inn-app-server
                secrets: |
                    ASPNETCORE_ENVIRONMENT=Release
                build-args: |
                    build_mode=Release

          - name: "Run deploy on server"
            uses: appleboy/ssh-action@master
            with:
                host: ${{ secrets.SERVER_HOST }}
                username: ${{ secrets.SERVER_USERNAME }}
                key: ${{ secrets.SERVER_KEY }}
                port: ${{ secrets.SERVER_PORT }}
                script: |
                    sudo docker pull ${{ secrets.DOCKERHUB_USER }}/test:inn-app-server
                    sudo docker container run -p 3000:3000 -d --restart unless-stopped --name inn-app-server ${{ secrets.DOCKERHUB_USER }}/test:inn-app-server
